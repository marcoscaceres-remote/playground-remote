<!DOCTYPE html>
<title>Application badge API test</title>
<meta name="theme-color" content="red" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="apple-touch-icon" href="icon.png" />
<link rel="manifest" href="manifest.json" />
<body>
    <h2>Badger</h2>
    <input type="number" id="badge" value="1" />
    <div>
      <output id="output">...idle...</output>
    </div>
    <div>
      <button id="notification">Request notifications permission</button>
    </div>
    <script>
        const badgeInput = document.getElementById("badge");
        const output = document.getElementById("output");
        const notificationButton = document.getElementById("notification");
        notificationButton.addEventListener("click", async () => {
            try {
                const permission = await Notification.requestPermission();
                output.innerHTML = `<br>Notification permission: ${permission}`;
            } catch (e) {
                output.innerHTML = `<br>Error: ${e.message}`;
            }
        });
        badgeInput.addEventListener("change", async () => {
            try {
                switch (true) {
                  case badgeInput.value === "":
                    await navigator.clearAppBadge();
                    output.innerHTML = `<br>Success. Cleared badge.`;
                    break;
                  case badgeInput.value === "0":
                    await navigator.setAppBadge(0);
                    output.innerHTML = `<br>Success. Set badge to 0 (cleared).`;
                    break;
                  case parseInt(badgeInput.value) < 0:
                    await navigator.setAppBadge();
                    output.innerHTML = `<br>Success. Set badge to flag.`;
                    break
                  default:
                    await navigator.setAppBadge(badgeInput.value);
                    output.innerHTML = `<br>Success. Set badge to ${badgeInput.value}.`;
                }
            } catch (e) {
                output.innerHTML = `<br>Error: ${e.message}`;
            }
        });
        // register service worker
        window.onload = async () => {
            try {
                const reg = await navigator.serviceWorker.register("sw.js");
                output.innerHTML += `Service worker registered.`;
            } catch (e) {
                output.innerHTML += `Service worker registration failed: ${e.message}`;
            }
            const {state} = await navigator.permissions.query({name: "notifications"});
            output.innerHTML += `Notifications permission is "${state}".`;
        };
    </script>
</body>
